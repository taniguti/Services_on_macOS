#!/bin/bash

function _readlink(){
    c="$1"
    f=$( basename "$c" )
    if [ "$( type -a "$c" 2> /dev/null | head -1 )x" = x ]; then
        d="$( cd "$(dirname "$c")" || exit 1 ; pwd )"
    else
        p="$( type -a "$c" | head -1 | awk '{$1="";$2=""; print $0}' | sed 's/^[ \t]*//' )"
        d="$( dirname "$p" )"
    fi
    if [ -L "${d}/${f}" ]; then
        cd "${d}" || exit 1
        r="$( readlink -n "${d}/${f}" )"
        _readlink "$r"
    else
        echo "${d}/${f}"
    fi
}

fullpath_to_me=$( _readlink "$0" )
pathtome=$( dirname "$fullpath_to_me" )
PREVIOUSCONFDIR="/Library/Server/Mail/Config/dovecot"
CONFDIR="/usr/local/etc/dovecot"
CONF="${CONFDIR}/dovecot.conf"
launchdplist="${pathtome}/../LaunchDaemons/org.dovecot.dovecotd.plist"
default_internal_group=_dovecot
default_internal_user=_dovecot
default_login_user=_dovenull
# _dovecot g- mail
# _dovenull g- _dovenull

: Check if dovecot is installed.
if [ ! -x /usr/local/bin/brew ]; then
    echo "setup Homebrew."
    exit 1
fi

if [ "$( brew list -1 | grep dovecot )" -ne 1 ]; then
    echo "Install deovecot with Homebrew."
    echo "Type brew install dovecot"
    exit 1
fi

if [ -d "$PREVIOUSCONFDIR" ]; then


fi


: Prepare Configuration
if [ -f "${CONF}" ]; then
    backupdate="$( date +%Y%m%d-%H%M%S )"
    mv "${CONF}" "${CONF}.backup.at.$backupdate"
fi

: Check master.cf of postfix

: Prepare launchd.plist


#       /usr/local/etc/dovecot/dovecot.conf
#              Dovecot's main configuration file.
#
#       /usr/local/etc/dovecot/dovecot-ldap.conf.ext
#              Dovecot's LDAP authdb/userdb module configuration file.
#
#       /usr/local/etc/dovecot/dovecot-sql.conf.ext
#              Dovecot's SQL authdb/userdb module configuration file.
#
#       /usr/local/etc/dovecot/dovecot-dict-sql.conf.ext
#              Dovecot's dict configuration with SQL-backend.
#
#       /usr/local/etc/dovecot/conf.d/auth-*-conf.ext
#              Configuration files of different authentication modules.
#
#       /usr/local/etc/dovecot/conf.d/*.conf
#              Configuration files of different services and settings.
