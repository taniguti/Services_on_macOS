#!/bin/bash

iam=`basename "$0"`
opt='-U'
KEYCHAIN='/Library/Keychains/System.keychain'
SNAME='com.apple.net.racoon'
PNAME="com.apple.RemoteAccessServers.plist"
CDIR="/Library/Preferences/SystemConfiguration"

function _readlink(){
    f=`basename "$1"`
    d=`cd $(dirname "$1"); pwd`
    if [ -L "${d}/${f}" ]; then
        r="`readlink -n \"${d}/${f}\"`"
        _readlink "$r"
    else
        echo "${d}/${f}"
    fi
}

function show_help(){
    cat <<_HELP

    $iam -s: Show preshared key for VPN service.
    $iam -c <preshared_key>: Replace preshared key with new one. If it is not set, set new one.

_HELP
}

function check(){
    isFile=yes
    if [ -f "${CDIR}/${PNAME}" ]; then
        ENCRYPT=`PlistBuddy -c "print  Servers:com.apple.ppp.l2tp:IPSec:SharedSecretEncryption" "${CDIR}/${PNAME}"`
        PSK_ACCOUNT=`/usr/libexec/PlistBuddy -c "print  Servers:com.apple.ppp.l2tp:IPSec:SharedSecret" "${CDIR}/${PNAME}"`
    else
        isFile=no
    fi
}

if [ $# = 0 ]; then 
    show_help
    exit 1
fi

if [ `whoami` != root ]; then
    echo "Use me with 'sudo'"
    show_help
    exit 1
fi

fullpath_to_me=`_readlink "$0"`
pathtome="`dirname \"$fullpath_to_me\"`"

while getopts cdhs sw
do
    case $sw in
        c)
            NEW_PSK="${OPTARG}"
            check
            if [ $isFile = yes ]; then
                if [ "${PSK_ACCOUNT}X" = X ]; then
                    echo "Failed to get Preshared Key" >&2
                    exit 1
                fi
                if [ "${ENCRYPT}X" = X ]; then
                    echo "Unknown Shared Secret Encryption" >&2
                    exit 1
                fi
                if [ "${NEW_PSK}X" = X ]; then
                    NEW_PSK=`openssl rand -base64 32 | fold -w 32 | head -1`
                fi
                CURRENT_PSK=`security find-generic-password -w -a $PSK_ACCOUNT "$KEYCHAIN"`
                if [ "${CURRENT_PSK}"X = X ]; then
                    opt='-A'
                else
                    opt='-U -A'
                fi
                security add-generic-password $opt -s $SNAME -a $PSK_ACCOUNT -w "$NEW_PSK" "$KEYCHAIN"
            else
                echo "Not found ${CDIR}/${PNAME}" >&2
                echo "VPN services is not configured yet" >&2
                exit 1
            fi
            ;;
        d)
            check
            if [ $isFile = yes ]; then
                if [ "${PSK_ACCOUNT}X" = X ]; then
                    echo "Failed to get Preshared Key" >&2
                    exit 1
                fi
                if [ "${ENCRYPT}X" = X ]; then
                    echo "Unknown Shared Secret Encryption" >&2
                    exit 1
                fi
                CURRENT_PSK=`security find-generic-password -w -a $PSK_ACCOUNT "$KEYCHAIN"`
                if [ "${CURRENT_PSK}"X != X ]; then
                    security delete-generic-password -s $SNAME  -a $PSK_ACCOUNT "$KEYCHAIN" > /dev/null 2>&1
                fi
            fi
            ;;
        s)
            check
            if [ $isFile = yes ]; then
                if [ "${PSK_ACCOUNT}X" = X ]; then
                    echo "Failed to get Preshared Key" >&2
                    exit 1
                fi
                if [ "${ENCRYPT}X" != "KeychainX" ]; then
                    echo "Unknown Shared Secret Encryption" >&2
                    exit 1
                fi
                security find-generic-password -w -a $PSK_ACCOUNT "$KEYCHAIN"
            else
                echo "Not found ${CDIR}/${PNAME}" >&2
                echo "VPN services is not configured yet" >&2
                exit 1
            fi
            ;;
        *)
            show_help
            exit 0
            ;;
    esac
done
